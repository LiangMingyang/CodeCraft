// Generated by CoffeeScript 1.9.2
(function() {
  var CONTEST_PAGE, HOME_PAGE, LOGIN_PAGE, myUtils;

  myUtils = require('./utils');

  LOGIN_PAGE = '/user/login';

  HOME_PAGE = '/';

  CONTEST_PAGE = '/contest';

  module.exports = [
    function(req, res, next) {
      return myUtils.findContest(req, req.params.contestID).then(function(contest) {
        var order;
        if (!contest) {
          throw new myUtils.Error.UnknownContest();
        }
        if (contest.start_time > (new Date())) {
          throw new myUtils.Error.UnknownContest();
        }
        req.body.contest = contest;
        order = myUtils.lettersToNumber(req.params.problemID);
        return contest.getProblems({
          through: {
            where: {
              order: order
            }
          },
          attributes: ['id']
        });
      }).then(function(problems) {
        if (problems.length === 0) {
          throw new myUtils.Error.UnknownProblem();
        }
        return req.body.problemID = problems[0].id;
      }).then(function() {
        return next();
      })["catch"](myUtils.Error.UnknownContest, myUtils.Error.UnknownProblem, function(err) {
        req.flash('info', err.message);
        return res.redirect(CONTEST_PAGE);
      })["catch"](function(err) {
        console.log(err);
        req.flash('info', 'Unknown error');
        return res.redirect(HOME_PAGE);
      });
    }
  ];

}).call(this);

//# sourceMappingURL=middlewares.js.map
